<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EGEO - TA | Consulta Live</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&display=swap');
        
        body { font-family: 'Inter', sans-serif; background-color: #ffffff; color: #1e293b; margin: 0; }

        /* Container que permite scroll lateral mas mant√©m a estrutura */
        .board-wrapper {
            display: flex;
            padding: 0;
            overflow-x: auto;
            align-items: flex-start;
            -webkit-overflow-scrolling: touch;
        }

        .driver-column {
            min-width: 400px; /* Largura no PC */
            flex: 1 0 auto;
            border-right: 1px solid #f1f5f9;
            background: white;
        }

        /* Ajuste para Telem√≥vel */
        @media (max-width: 768px) {
            .driver-column { 
                min-width: 88vw; /* Ocupa quase o ecr√£ todo para ser claro */
            }
        }

        .driver-title {
            padding: 1.5rem;
            font-weight: 900;
            text-align: center;
            border-bottom: 2px solid #f1f5f9;
            font-size: 1.75rem;
            text-transform: uppercase;
            position: sticky;
            top: 0;
            background: white;
            z-index: 30;
        }

        /* C√©lula de dia com altura m√≠nima e transi√ß√£o suave */
        .day-cell {
            padding: 1.5rem;
            border-bottom: 1px solid #f1f5f9;
            display: flex;
            flex-direction: column;
            box-sizing: border-box;
            transition: height 0.1s ease-in-out;
        }

        .day-label {
            font-size: 1.25rem;
            font-weight: 900;
            margin-bottom: 1rem;
            text-transform: uppercase;
        }

        .service-bubble {
            background-color: #f8fafc;
            border: 1px solid #e2e8f0;
            border-left: 5px solid #1e293b;
            border-radius: 1rem;
            padding: 1rem;
            margin-bottom: 0.75rem;
        }

        .sticky-header { 
            position: sticky; 
            top: 0; 
            background: white; 
            z-index: 100; 
            border-bottom: 1px solid #f1f5f9;
        }
        
        /* Evita que o texto quebre de forma estranha */
        .servico-desc {
            word-break: break-word;
            font-size: 0.95rem;
            line-height: 1.4;
        }

        #loader { transition: opacity 0.3s ease; }
    </style>
</head>
<body>

    <div id="loader" class="fixed inset-0 bg-white z-[2000] flex flex-col items-center justify-center">
        <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-blue-600 mb-2"></div>
        <p class="text-[10px] font-bold uppercase tracking-widest">A sincronizar...</p>
    </div>

    <header class="p-4 sticky-header">
        <div class="max-w-[2500px] mx-auto flex flex-wrap justify-between items-center gap-4">
            <div class="flex items-center gap-2">
                <span class="text-2xl">üöõ</span>
                <h1 class="text-xl font-black tracking-tighter">EGEO - TA</h1>
            </div>
            
            <div class="flex items-center gap-3">
                <select id="driver-filter" onchange="applyFilter()" class="bg-slate-100 border-none rounded-lg px-3 py-2 text-[10px] font-black uppercase outline-none">
                    <option value="all">TODOS</option>
                </select>
                <button onclick="goToday()" class="px-3 py-2 text-[10px] font-bold uppercase border border-slate-200 rounded-lg">Hoje</button>
                <div class="flex items-center gap-2 bg-slate-50 px-3 py-1 rounded-lg border border-slate-100">
                    <button onclick="changeWeek(-1)" class="p-1">‚óÄ</button>
                    <span id="week-label" class="text-[10px] font-black font-mono"></span>
                    <button onclick="changeWeek(1)" class="p-1">‚ñ∂</button>
                </div>
            </div>
        </div>
    </header>

    <main id="board" class="board-wrapper"></main>

    <script>
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwvZ6RDtubzNKAbm0MqyJLVLq6E6x1CdZBtoNhl9OTf3FKImo3lPGdHpSfMoKdr0l-2/exec';
        let currentMonday = getMonday(new Date());
        let appData = { motoristas: [], historico: [] };

        const weekDays = ["DOM", "SEG", "TER", "QUA", "QUI", "SEX", "S√ÅB"];
        const months = ["Jan", "Fev", "Mar", "Abr", "Mai", "Jun", "Jul", "Ago", "Set", "Out", "Nov", "Dez"];

        function getMonday(d) {
            d = new Date(d);
            let day = d.getDay(), diff = d.getDate() - day + (day == 0 ? -6 : 1);
            return new Date(d.setDate(diff));
        }

        async function loadData() {
            document.getElementById('loader').style.opacity = '1';
            document.getElementById('loader').style.display = 'flex';
            try {
                const resp = await fetch(SCRIPT_URL);
                appData = await resp.json();
                populateFilter();
                render();
            } catch (e) { console.error(e); }
            document.getElementById('loader').style.opacity = '0';
            setTimeout(() => document.getElementById('loader').style.display = 'none', 300);
        }

        function populateFilter() {
            const select = document.getElementById('driver-filter');
            const currentVal = select.value;
            select.innerHTML = '<option value="all">TODOS</option>';
            appData.motoristas.forEach(mot => {
                const opt = document.createElement('option');
                opt.value = mot; opt.innerText = mot.toUpperCase();
                select.appendChild(opt);
            });
            select.value = currentVal;
        }

        function render() {
            const board = document.getElementById('board');
            board.innerHTML = '';
            
            const formatDate = (date) => `${date.getDate()}/${months[date.getMonth()]}`;
            document.getElementById('week-label').innerText = `${formatDate(currentMonday)} ‚Äî ${formatDate(new Date(new Date(currentMonday).setDate(currentMonday.getDate() + 6)))}`;

            appData.motoristas.forEach(mot => {
                const col = document.createElement('div');
                col.className = "driver-column";
                col.setAttribute('data-motorista', mot);
                
                let html = `<div class="driver-title">${mot}</div>`;
                
                for(let i=0; i<7; i++) {
                    const d = new Date(currentMonday); d.setDate(d.getDate() + i);
                    const ds = formatDate(d);
                    const dWeek = weekDays[d.getDay()];
                    const isToday = new Date().toLocaleDateString() === d.toLocaleDateString();
                    
                    const rowColor = i % 2 === 0 ? 'bg-white' : 'bg-slate-50/40';
                    const services = appData.historico.filter(h => h.motorista.trim().toLowerCase() === mot.trim().toLowerCase() && h.data === ds);

                    html += `
                        <div class="day-cell ${isToday ? 'bg-blue-50/60' : rowColor}" data-day-index="${i}">
                            <div class="day-label ${isToday ? 'text-blue-600' : 'text-slate-400'}">
                                ${dWeek}, ${ds}
                            </div>
                            <div class="services-container space-y-2">
                                ${services.length > 0 ? services.map(s => `
                                    <div class="service-bubble">
                                        <div class="text-[9px] font-black text-blue-600 uppercase mb-1">${s.viatura || ''}</div>
                                        <div class="servico-desc font-bold text-slate-800">${s.servico}</div>
                                        ${s.nei && s.nei !== '---' ? `<div class="mt-2 text-[10px] font-mono text-slate-400 font-bold"># ${s.nei}</div>` : ''}
                                    </div>
                                `).join('') : '<div class="text-[10px] font-bold text-slate-200 uppercase py-2">Sem servi√ßo</div>'}
                            </div>
                        </div>`;
                }
                col.innerHTML = html;
                board.appendChild(col);
            });
            
            // For√ßar nivelamento ap√≥s renderizar
            setTimeout(equalizeHeights, 100);
        }

        function equalizeHeights() {
            // No mobile, se estivermos a ver "TODOS", nivelamos. Se filtrarmos 1, resetamos.
            const filterValue = document.getElementById('driver-filter').value;
            const visibleCols = document.querySelectorAll('.driver-column:not([style*="display: none"])');
            
            // Resetar alturas primeiro
            document.querySelectorAll('.day-cell').forEach(c => c.style.height = 'auto');

            if (visibleCols.length > 1) {
                for (let i = 0; i < 7; i++) {
                    let maxHeight = 0;
                    // Selecionar c√©lulas do dia 'i' apenas das colunas vis√≠veis
                    const dayCells = [];
                    visibleCols.forEach(col => {
                        const cell = col.querySelector(`[data-day-index="${i}"]`);
                        if (cell) {
                            dayCells.push(cell);
                            if (cell.offsetHeight > maxHeight) maxHeight = cell.offsetHeight;
                        }
                    });
                    // Aplicar a altura m√°xima a todas as c√©lulas desse dia
                    dayCells.forEach(cell => cell.style.height = maxHeight + 'px');
                }
            }
        }

        window.applyFilter = function() {
            const val = document.getElementById('driver-filter').value;
            document.querySelectorAll('.driver-column').forEach(col => {
                col.style.display = (val === 'all' || col.getAttribute('data-motorista') === val) ? 'block' : 'none';
            });
            equalizeHeights();
        }

        window.goToday = function() { currentMonday = getMonday(new Date()); loadData(); }
        window.changeWeek = function(dir) { currentMonday.setDate(currentMonday.getDate() + (dir*7)); render(); }
        
        // Ajustar nivelamento se rodar o telem√≥vel (mudan√ßa de orienta√ß√£o)
        window.addEventListener('resize', equalizeHeights);

        loadData();
    </script>
</body>
</html>
