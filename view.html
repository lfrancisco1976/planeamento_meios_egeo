<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PRO-MAP | Planeamento de Frota</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&display=swap');
        
        body { font-family: 'Inter', sans-serif; background-color: #ffffff; color: #1e293b; }

        .board-wrapper {
            display: flex;
            padding: 1rem;
            overflow-x: auto;
            gap: 0;
            min-height: 85vh;
            scroll-behavior: smooth;
        }

        .driver-column {
            min-width: 420px;
            flex: 1;
            border-right: 1px solid #f1f5f9;
            transition: opacity 0.3s ease;
        }

        @media (max-width: 768px) {
            .driver-column { min-width: 90vw; }
        }

        .day-cell {
            padding: 2rem;
            border-bottom: 1px solid #f1f5f9;
            display: flex;
            flex-direction: column;
        }

        .service-bubble {
            background-color: #f8fafc;
            border: 1px solid #e2e8f0;
            border-left: 6px solid #1e293b;
            border-radius: 1.25rem;
            padding: 1.5rem;
            margin-bottom: 1rem;
        }

        .sticky-header { position: sticky; top: 0; background: white; z-index: 50; }
        
        /* Scrollbar Personalizada */
        ::-webkit-scrollbar { height: 8px; }
        ::-webkit-scrollbar-track { background: #f8fafc; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
    </style>
</head>
<body>

    <div id="loader" class="fixed inset-0 bg-white z-[2000] flex flex-col items-center justify-center">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mb-4"></div>
        <p class="text-xs font-black uppercase tracking-[0.3em] text-slate-400">Sincronizando Live...</p>
    </div>

    <header class="border-b border-slate-100 p-4 md:p-6 sticky-header">
        <div class="max-w-[2500px] mx-auto flex flex-col md:flex-row justify-between items-center gap-6">
            
            <div class="flex items-center gap-4">
                <span class="text-4xl">ðŸš›</span>
                <div>
                    <h1 class="text-2xl font-black tracking-tighter leading-none">PRO-MAP</h1>
                    <span class="text-[10px] font-black text-blue-600 uppercase tracking-widest">Consulta de Motoristas</span>
                </div>
            </div>
            
            <div class="flex flex-wrap items-center justify-center gap-4">
                <div class="relative">
                    <select id="driver-filter" onchange="applyFilter()" class="appearance-none bg-slate-900 text-white px-6 py-3 rounded-2xl text-xs font-black uppercase tracking-widest outline-none hover:bg-blue-600 transition cursor-pointer">
                        <option value="all">TODOS OS MOTORISTAS</option>
                    </select>
                </div>

                <button onclick="goToday()" class="px-6 py-3 text-xs font-black uppercase border-2 border-slate-100 rounded-2xl hover:bg-slate-50 transition">Hoje</button>
                
                <div class="flex items-center gap-4 bg-slate-50 px-4 py-2 rounded-2xl border border-slate-100">
                    <button onclick="changeWeek(-1)" class="text-xl font-bold hover:text-blue-600 transition">â—€</button>
                    <span id="week-label" class="text-xs font-black uppercase tracking-widest font-mono min-w-[160px] text-center"></span>
                    <button onclick="changeWeek(1)" class="text-xl font-bold hover:text-blue-600 transition">â–¶</button>
                </div>
            </div>
        </div>
    </header>

    <main id="board" class="board-wrapper"></main>

    <script>
        // SUBSTITUI PELO TEU URL DO GOOGLE SCRIPT
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwvZ6RDtubzNKAbm0MqyJLVLq6E6x1CdZBtoNhl9OTf3FKImo3lPGdHpSfMoKdr0l-2/exec';
        
        let currentMonday = getMonday(new Date());
        let appData = { motoristas: [], historico: [] };

        function getMonday(d) {
            d = new Date(d); let day = d.getDay(), diff = d.getDate() - day + (day == 0 ? -6 : 1);
            return new Date(d.setDate(diff));
        }

        function goToday() { currentMonday = getMonday(new Date()); loadData(); }

        async function loadData() {
            document.getElementById('loader').style.display = 'flex';
            try {
                const resp = await fetch(SCRIPT_URL);
                appData = await resp.json();
                populateFilter();
                render();
            } catch (e) { 
                console.error(e);
                alert("Erro ao carregar dados. Verifique a ligaÃ§Ã£o.");
            }
            document.getElementById('loader').style.display = 'none';
        }

        function populateFilter() {
            const select = document.getElementById('driver-filter');
            const currentVal = select.value;
            select.innerHTML = '<option value="all">TODOS OS MOTORISTAS</option>';
            appData.motoristas.sort().forEach(mot => {
                const opt = document.createElement('option');
                opt.value = mot;
                opt.innerText = mot.toUpperCase();
                select.appendChild(opt);
            });
            select.value = currentVal;
        }

        function applyFilter() {
            const val = document.getElementById('driver-filter').value;
            document.querySelectorAll('.driver-column').forEach(col => {
                col.style.display = (val === 'all' || col.getAttribute('data-motorista') === val) ? 'block' : 'none';
            });
            equalizeHeights();
        }

        function render() {
            const board = document.getElementById('board');
            board.innerHTML = '';
            const months = ["Jan", "Fev", "Mar", "Abr", "Mai", "Jun", "Jul", "Ago", "Set", "Out", "Nov", "Dez"];
            const formatDate = (date) => `${date.getDate()}/${months[date.getMonth()]}`;
            
            document.getElementById('week-label').innerText = `${formatDate(currentMonday)} â€” ${formatDate(new Date(new Date(currentMonday).setDate(currentMonday.getDate() + 6)))}`;

            appData.motoristas.forEach(mot => {
                const col = document.createElement('div');
                col.className = "driver-column";
                col.setAttribute('data-motorista', mot);
                
                let html = `<div class="p-8 font-black text-center border-b border-slate-100 uppercase tracking-tighter text-3xl sticky top-[80px] md:top-[96px] bg-white z-20">${mot}</div>`;
                
                for(let i=0; i<7; i++) {
                    const d = new Date(currentMonday); d.setDate(d.getDate() + i);
                    const ds = formatDate(d);
                    const isToday = new Date().toLocaleDateString() === d.toLocaleDateString();
                    const rowColor = i % 2 === 0 ? 'bg-white' : 'bg-slate-50/40';
                    const services = appData.historico.filter(h => h.motorista.trim().toLowerCase() === mot.trim().toLowerCase() && h.data === ds);

                    html += `
                        <div class="day-cell ${isToday ? 'bg-blue-50/50' : rowColor}" id="day-${i}-${mot.replace(/\s+/g, '')}">
                            <div class="mb-6">
                                <span class="text-2xl font-black uppercase tracking-tight ${isToday ? 'text-blue-600' : 'text-slate-300'}">
                                    ${ds} ${isToday ? 'â€¢ HOJE' : ''}
                                </span>
                            </div>
                            <div class="flex-grow space-y-4">
                                ${services.length > 0 ? services.map(s => `
                                    <div class="service-bubble">
                                        <div class="text-[10px] font-black text-blue-600 uppercase tracking-[0.2em] mb-2">${s.viatura || 'Sem Viatura'}</div>
                                        <div class="text-lg font-bold leading-tight text-slate-800">${s.servico}</div>
                                        ${s.nei && s.nei !== '---' ? `<div class="mt-4 text-xs font-mono text-slate-500 font-bold bg-white border border-slate-200 px-3 py-1.5 rounded-lg inline-block">ID: ${s.nei}</div>` : ''}
                                    </div>
                                `).join('') : '<div class="py-4 text-[10px] font-bold text-slate-200 uppercase tracking-widest">Sem registos</div>'}
                            </div>
                        </div>`;
                }
                col.innerHTML = html;
                board.appendChild(col);
            });
            applyFilter();
        }

        function equalizeHeights() {
            if(window.innerWidth < 768) {
                document.querySelectorAll('.day-cell').forEach(c => c.style.height = 'auto');
                return;
            }
            setTimeout(() => {
                for (let i = 0; i < 7; i++) {
                    let maxHeight = 0;
                    const dayCells = document.querySelectorAll(`[id^="day-${i}-"]`);
                    dayCells.forEach(cell => {
                        cell.style.height = 'auto';
                        if (cell.parentElement.style.display !== 'none' && cell.offsetHeight > maxHeight) {
                            maxHeight = cell.offsetHeight;
                        }
                    });
                    dayCells.forEach(cell => { if (maxHeight > 0) cell.style.height = maxHeight + 'px'; });
                }
            }, 100);
        }

        function changeWeek(dir) { currentMonday.setDate(currentMonday.getDate() + (dir*7)); render(); }
        loadData();
    </script>
</body>
</html>
