<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Planeamento Logístico</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-100 font-sans">

    <header class="bg-white shadow-md p-4 sticky top-0 z-10">
        <div class="max-w-7xl mx-auto flex flex-wrap justify-between items-center gap-4">
            <h1 class="text-2xl font-bold text-slate-800">Planeamento Semanal</h1>
            
            <div class="flex items-center gap-2 bg-slate-200 rounded-lg p-1">
                <button onclick="changeWeek(-1)" class="p-2 hover:bg-white rounded shadow-sm">◀</button>
                <span id="current-week-display" class="px-4 font-semibold text-slate-700 min-w-[200px] text-center"></span>
                <button onclick="changeWeek(1)" class="p-2 hover:bg-white rounded shadow-sm">▶</button>
            </div>

            <button onclick="loadFromSheets()" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition">
                Atualizar Dados ↻
            </button>
        </div>
    </header>

    <main id="planning-grid" class="p-4 flex gap-6 overflow-x-auto min-h-screen">
        <div class="flex items-center justify-center w-full text-slate-400">A carregar definições do Sheets...</div>
    </main>

    <script>
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwGZ6pf5DtKzrbPJotS15zd16BDEOVOMKs9OI9vwc7BYFjR7m6kQtSFnPwjv6Q03jcb/exec';
        let currentMonday = getMonday(new Date());
        let db = { motoristas: [], tratores: [], reboques: [] };

        function getMonday(d) {
            d = new Date(d);
            var day = d.getDay(), diff = d.getDate() - day + (day == 0 ? -6 : 1);
            return new Date(d.setDate(diff));
        }

        function formatDate(date) {
            const months = ["Jan", "Fev", "Mar", "Abr", "Mai", "Jun", "Jul", "Ago", "Set", "Out", "Nov", "Dez"];
            return `${date.getDate()}/${months[date.getMonth()]}`;
        }

        async function loadFromSheets() {
            try {
                const response = await fetch(SCRIPT_URL);
                db = await response.json();
                renderBoard();
            } catch (e) {
                alert("Erro ao ligar ao Sheets. Verifique o URL do Script.");
            }
        }

        function changeWeek(weeks) {
            currentMonday.setDate(currentMonday.getDate() + (weeks * 7));
            renderBoard();
        }

        function renderBoard() {
            const grid = document.getElementById('planning-grid');
            const weekDisplay = document.getElementById('current-week-display');
            grid.innerHTML = '';
            
            const sun = new Date(currentMonday);
            sun.setDate(sun.getDate() + 6);
            weekDisplay.innerText = `${formatDate(currentMonday)} a ${formatDate(sun)}`;

            db.motoristas.forEach(mot => {
                let col = document.createElement('div');
                col.className = "min-w-[320px] flex-shrink-0 bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden";
                
                let html = `<div class="bg-slate-800 text-white p-3 font-bold text-center">${mot}</div>`;
                
                for(let i=0; i<7; i++) {
                    let dayDate = new Date(currentMonday);
                    dayDate.setDate(dayDate.getDate() + i);
                    const dayName = ["Segunda", "Terça", "Quarta", "Quinta", "Sexta", "Sábado", "Domingo"][i];
                    const dateStr = formatDate(dayDate);

                    html += `
                    <div class="p-3 border-b border-slate-100 bg-slate-50/50">
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-xs font-bold text-slate-500 uppercase">${dayName} (${dateStr})</span>
                            <button onclick="addRow('${mot}', '${dateStr}', this)" class="text-blue-600 text-xs font-bold">+ NOVO</button>
                        </div>
                        <div class="space-y-2" id="tasks-${mot}-${i}"></div>
                    </div>`;
                }
                col.innerHTML = html;
                grid.appendChild(col);
            });
        }

        function addRow(motorista, dataStr, btn) {
            const container = btn.closest('div').nextElementSibling;
            if (container.children.length >= 15) return;

            const row = document.createElement('div');
            row.className = "bg-white p-2 rounded border border-slate-200 shadow-sm text-sm space-y-2";
            row.innerHTML = `
                <div class="flex gap-1">
                    <select class="w-1/2 border rounded p-1 text-xs" name="trator">
                        ${db.tratores.map(t => `<option>${t}</option>`).join('')}
                    </select>
                    <select class="w-1/2 border rounded p-1 text-xs" name="reboque">
                        ${db.reboques.map(r => `<option>${r}</option>`).join('')}
                    </select>
                </div>
                <input type="text" placeholder="Serviço" name="serv" class="w-full border rounded p-1 text-xs">
                <input type="text" placeholder="Encomenda (NEI)" name="nei" class="w-full border rounded p-1 text-xs font-mono">
                <div class="flex justify-between items-center">
                    <button onclick="saveRow(this, '${motorista}', '${dataStr}')" class="text-green-600 font-bold text-[10px]">GRAVAR NO SHEETS</button>
                    <button onclick="this.parentElement.parentElement.remove()" class="text-red-400">✕</button>
                </div>
            `;
            container.appendChild(row);
        }

        async function saveRow(btn, motorista, dataStr) {
            const row = btn.closest('div').parentElement;
            const payload = {
                action: "add",
                data: dataStr,
                motorista: motorista,
                viatura: row.querySelector('[name="trator"]').value + " / " + row.querySelector('[name="reboque"]').value,
                servico: row.querySelector('[name="serv"]').value,
                nei: row.querySelector('[name="nei"]').value
            };

            btn.innerText = "A ENVIAR...";
            await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify(payload) });
            btn.innerText = "SINCRO ✓";
            btn.classList.replace('text-green-600', 'text-slate-400');
            btn.disabled = true;
        }

        // Início automático
        loadFromSheets();
    </script>
</body>
</html>
